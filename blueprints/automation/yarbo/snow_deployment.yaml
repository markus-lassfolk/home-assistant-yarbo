blueprint:
  name: Yarbo Snow Deployment
  description: >
    Automatically notify and optionally start a snow clearing plan when snowfall
    is detected above a configurable threshold.
    Works with any HA sensor: Met.no, OpenWeatherMap, Ecowitt, and others.
  domain: automation
  author: markus-lassfolk
  source_url: https://github.com/markus-lassfolk/home-assistant-yarbo

  input:
    yarbo_device:
      name: Yarbo Robot
      description: The Yarbo robot device to control (must have Snow Blower head installed).
      selector:
        device:
          integration: yarbo

    snowfall_sensor:
      name: Snowfall Sensor
      description: >
        Sensor measuring snowfall amount (mm). Triggers deployment when value
        exceeds the threshold. Compatible with Met.no, OpenWeatherMap, Ecowitt,
        and other weather integrations.
      selector:
        entity:
          domain: sensor

    threshold:
      name: Snowfall Threshold (mm)
      description: Trigger deployment when the sensor value exceeds this amount.
      default: 5
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: mm
          mode: box

    notify_target:
      name: Notification Target
      description: >
        Notification service to alert about snow deployment
        (e.g. notify.mobile_app_phone).
      selector:
        text:
          multiline: false

    plan_id:
      name: Snow Clearing Plan ID (optional)
      description: >
        UUID of the snow clearing work plan to start. Leave empty to only send a
        notification without starting a plan automatically.
        Find the plan UUID in the Yarbo app under Plans.
      default: ""
      selector:
        text:
          multiline: false

variables:
  plan_id_var: !input plan_id

trigger:
  - platform: numeric_state
    entity_id: !input snowfall_sensor
    above: !input threshold

action:
  - service: !input notify_target
    data:
      title: "Yarbo Snow Alert"
      message: >
        Snowfall detected: {{ trigger.to_state.state }} mm (threshold: {{ threshold }} mm).
        {% if plan_id_var | trim != '' %}Starting snow clearing plan.{% else %}No plan configured â€” start manually if needed.{% endif %}
  - if:
      - condition: template
        value_template: "{{ plan_id_var | trim != '' }}"
    then:
      - service: yarbo.start_plan
        data:
          device_id: !input yarbo_device
          plan_id: "{{ plan_id_var }}"

mode: single
max_exceeded: silent
